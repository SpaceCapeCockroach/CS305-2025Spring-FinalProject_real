<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P 网络仪表盘</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #0f3460;
            --highlight: #e94560;
            --text: #f1f1f1;
            --text-secondary: #b0b0b0;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* 侧边栏样式 */
        .sidebar {
            width: 250px;
            background: rgba(10, 10, 20, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        
        .logo {
            display: flex;
            align-items: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }
        
        .logo i {
            font-size: 28px;
            color: var(--highlight);
            margin-right: 10px;
        }
        
        .logo h1 {
            font-size: 22px;
            font-weight: 600;
        }
        
        .nav-links {
            flex: 1;
        }
        
        .nav-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover, .nav-item.active {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid var(--highlight);
        }
        
        .nav-item i {
            width: 30px;
            font-size: 18px;
            color: var(--text-secondary);
        }
        
        .nav-item.active i {
            color: var(--highlight);
        }
        
        .nav-item span {
            font-size: 16px;
        }
        
        .system-info {
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.2);
            margin: 20px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .system-info div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .system-info div:last-child {
            margin-bottom: 0;
        }
        
        /* 主内容区样式 */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .header h2 {
            font-size: 28px;
            font-weight: 600;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            border: 1px solid var(--border);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stat-header i {
            font-size: 24px;
            background: rgba(255, 255, 255, 0.1);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-weight: 500;
        }
        
        .btn:hover {
            background: var(--highlight);
        }
        
        .block-node {
            margin: 10px 0;
        }

        .block-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            transition: all 0.2s;
        }
        .block-header:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .toggle-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: var(--highlight);
        }
        .toggle-icon i { 
             color: var(--highlight);
        }

        .block-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--highlight);
            margin-right: 10px;
            flex-shrink: 0;
        }

        .block-id { 
            font-weight: 600;
            font-size: 14px;
        }
        
        .block-info .block-hash { 
            font-size: 12px;
            color: var(--text-secondary);
            font-family: monospace;
            margin-top: 3px;
            word-break: break-all;
        }


        .children-container {
            margin-left: 30px;
            padding-left: 15px;
            border-left: 2px solid rgba(255, 255, 255, 0.1);
        }

        .block-details {
            margin-top: 5px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            font-size: 13px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 5px;
        }

        .detail-label {
            width: 100px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .detail-value {
            flex: 1;
            word-break: break-all;
        }

        .tx-list {
            margin-top: 5px;
            max-height: 150px;
            overflow-y: auto;
            padding: 5px;
            background: rgba(0, 0, 0, 0.1); 
            border-radius: 6px;
        }

        .tx-item {
            padding: 5px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            font-size: 12px;
            word-break: break-all;
        }

        .tx-item:last-child {
            margin-bottom: 0;
        }

        .search-box { 
            display: flex;
            margin-bottom: 15px;
        }

        .search-box input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.07);
            color: var(--text);
            font-size: 14px;
            outline: none;
        }
         .search-box input::placeholder {
            color: var(--text-secondary);
        }

        .search-box button {
            margin-left: 10px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .search-box button:hover {
            background: var(--highlight);
        }

        .empty-message {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-style: italic;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            font-weight: 500;
            border-bottom: 1px solid var(--border); 
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-online {
            background: rgba(74, 222, 128, 0.2);
            color: var(--success);
        }
        
        .status-offline {
            background: rgba(248, 113, 113, 0.2);
            color: var(--danger);
        }
        
        .status-syncing {
            background: rgba(251, 191, 36, 0.2);
            color: var(--warning);
        }
         .status-warning { /* For NAT status, etc. */
            background: rgba(251, 191, 36, 0.2);
            color: var(--warning);
        }
        .status-success { /* For NAT status, etc. */
             background: rgba(74, 222, 128, 0.2);
            color: var(--success);
        }

        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
        
        .peer-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .peer-full {
            background: rgba(79, 70, 229, 0.2);
            color: #6366f1;
        }
        
        .peer-light {
            background: rgba(14, 165, 233, 0.2);
            color: #0ea5e9;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 1200px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                border-right: none; 
                border-bottom: 1px solid var(--border); 
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
        }
        
        .search-bar { 
            display: flex;
            background: rgba(255, 255, 255, 0.07);
            border-radius: 8px;
            padding: 8px 15px;
            width: 300px;
            align-items: center;
        }
        
        .search-bar input {
            background: transparent;
            border: none;
            color: var(--text);
            flex: 1;
            padding: 5px 10px;
            outline: none;
        }
         .search-bar input::placeholder {
            color: var(--text-secondary);
        }
        
        .search-bar i {
            color: var(--text-secondary);
            margin-right: 8px; 
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress {
            height: 100%;
            background: var(--highlight);
            border-radius: 4px;
            transition: width 0.5s ease-in-out; 
        }
        
        .block-row { 
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .block-row:last-child {
            border-bottom: none;
        }
        
        .block-icon { 
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .block-icon i {
            color: var(--text); 
        }
        
        .block-info { 
            flex: 1;
        }
        
        .block-hash { 
            font-size: 14px;
            color: var(--text-secondary);
            font-family: monospace;
            word-break: break-all;
            margin-top: 2px; 
        }
        
        .latency-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .latency-low {
            background: var(--success);
        }
        
        .latency-medium {
            background: var(--warning);
        }
        
        .latency-high {
            background: var(--danger);
        }
        
        .queue-priority {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .priority-high {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .priority-medium {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
        }
        
        .priority-low {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .loading { 
            display: inline-block;
            width: 16px; 
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--highlight);
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px; 
            vertical-align: middle; 
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .refresh-btn {
            display: flex;
            align-items: center;
        }

        .loading-block .block-row {
             border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 侧边导航栏 -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-project-diagram"></i>
                <h1>P2P 仪表盘</h1>
            </div>
            
            <div class="nav-links">
                <div class="nav-item active" data-section="overview">
                    <i class="fas fa-home"></i>
                    <span>总览</span>
                </div>
                <div class="nav-item" data-section="blocks">
                    <i class="fas fa-cube"></i>
                    <span>区块浏览器</span>
                </div>
                <div class="nav-item" data-section="peers">
                    <i class="fas fa-network-wired"></i>
                    <span>节点监控</span>
                </div>
                <div class="nav-item" data-section="transactions">
                    <i class="fas fa-exchange-alt"></i>
                    <span>交易池</span>
                </div>
                <div class="nav-item" data-section="performance">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>网络性能</span>
                </div>
                <div class="nav-item" data-section="outbox">
                    <i class="fas fa-envelope"></i>
                    <span>消息队列</span>
                </div>
                <div class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>设置</span>
                </div>
            </div>
            
            <div class="system-info">
                <div>
                    <span>节点ID:</span>
                    <span id="node-id">加载中...</span>
                </div>
                <div>
                    <span>区块高度:</span>
                    <span id="block-height">#0</span>
                </div>
                <div>
                    <span>运行时间:</span>
                    <span id="uptime">0天 0小时</span>
                </div>
                <div>
                    <span>版本:</span>
                    <span>v2.1.4</span>
                </div>
            </div>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 总览页面 -->
            <div id="overview-page" data-page="overview">
                <div class="header">
                    <h2>网络总览</h2>
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="搜索区块、交易或节点..." id="search-input">
                    </div>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="active-peers">0</div>
                                <div class="stat-label">活跃节点</div>
                            </div>
                            <i class="fas fa-server"></i>
                        </div>
                        <div class="progress-bar">
                            <div class="progress" id="peers-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="block-count">0</div>
                                <div class="stat-label">区块高度</div>
                            </div>
                            <i class="fas fa-cubes"></i>
                        </div>
                        <div class="progress-bar">
                            <div class="progress" id="blocks-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="pending-txs">0</div>
                                <div class="stat-label">待处理交易</div>
                            </div>
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="progress-bar">
                            <div class="progress" id="txs-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="network-throughput">0 MB/s</div>
                                <div class="stat-label">网络吞吐量</div>
                            </div>
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <div class="progress-bar">
                            <div class="progress" id="throughput-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">最新区块</div>
                            <button class="btn" id="refresh-blocks">刷新</button>
                        </div>
                        <div class="block-list" id="blocks-list">
                            <div class="block-row">
                                <div class="block-icon">
                                    <i class="fas fa-cube"></i>
                                </div>
                                <div class="block-info">
                                    <div>加载区块数据中...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">节点状态</div>
                            <button class="btn refresh-btn" id="refresh-peers">
                                <span class="loading" style="display: none;"></span>刷新
                            </button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                       <th>节点ID</th>
                                       <th>IP地址</th>
                                       <th>端口</th>
                                       <th>状态</th>
                                       <th>延迟</th>
                                       <th>类型</th>
                                       <th>NAT状态</th>
                                       <th>本地网络</th>
                                    </tr>
                                </thead>
                                <tbody id="peers-table">
                                    <tr>
                                        <td colspan="8" style="text-align: center;">加载节点数据中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">网络性能</div>
                        <div>
                            <button class="btn active" id="latency-btn" style="margin-right: 10px;">延迟</button>
                            <button class="btn" id="throughput-btn">吞吐量</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="networkChart"></canvas>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">近期交易</div>
                            <button class="btn" id="refresh-txs">刷新</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>交易ID</th>
                                    <th>金额</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table">
                                <tr>
                                    <td colspan="3" style="text-align: center;">加载交易数据中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">待发送消息</div>
                            <button class="btn" id="refresh-outbox">刷新</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>目标节点</th>
                                    <th>优先级</th>
                                    <th>消息数</th>
                                </tr>
                            </thead>
                            <tbody id="outbox-table">
                                <tr>
                                    <td colspan="3" style="text-align: center;">加载消息队列数据中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 区块浏览器页面 -->
            <div id="blocks-page" style="display: none;" data-page="blocks">
                <div class="header">
                    <h2>区块浏览器</h2>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">区块链视图</div>
                        <button class="btn" id="refresh-blocks-tree">刷新</button>
                    </div>

                    <div class="search-box">
                        <input type="text" id="block-search-tree" placeholder="输入区块ID或交易ID...">
                        <button id="search-block-btn-tree">搜索</button>
                    </div>

                    <div id="blocks-tree-container">
                        <div class="loading-block">
                            <div class="block-row">
                                <div class="block-icon">
                                    <i class="fas fa-cube"></i>
                                </div>
                                <div class="block-info">
                                    <div>加载区块树结构中...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 其他页面占位符 -->
            <div id="peers-page" style="display: none;" data-page="peers">
                 <div class="header"><h2>节点监控</h2></div>
                 <div class="card"><p>节点监控内容将显示在这里。</p></div>
            </div>
            <div id="transactions-page" style="display: none;" data-page="transactions">
                <div class="header"><h2>交易池</h2></div>
                <div class="card"><p>交易池内容将显示在这里。</p></div>
            </div>
            <div id="performance-page" style="display: none;" data-page="performance">
                <div class="header"><h2>网络性能</h2></div>
                <div class="card"><p>网络性能图表和数据将显示在这里。</p></div>
            </div>
            <div id="outbox-page" style="display: none;" data-page="outbox">
                <div class="header"><h2>消息队列</h2></div>
                <div class="card"><p>消息队列内容将显示在这里。</p></div>
            </div>
            <div id="settings-page" style="display: none;" data-page="settings">
                <div class="header"><h2>设置</h2></div>
                <div class="card"><p>配置设置将显示在这里。</p></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let peerId = "0x" + Math.random().toString(16).substr(2, 12);
        let startTime = Date.now();
        let networkChart;
        let chartMode = 'latency'; // 'latency' or 'throughput'
        let latencyDataPoints = []; 
        let throughputDataPoints = [];

        // DOM元素
        const elements = {
            nodeId: document.getElementById('node-id'),
            blockHeightSysInfo: document.getElementById('block-height'), 
            uptime: document.getElementById('uptime'),
            
            activePeers: document.getElementById('active-peers'),
            blockCountStat: document.getElementById('block-count'), 
            pendingTxs: document.getElementById('pending-txs'),
            networkThroughput: document.getElementById('network-throughput'),
            peersProgress: document.getElementById('peers-progress'),
            blocksProgress: document.getElementById('blocks-progress'),
            txsProgress: document.getElementById('txs-progress'),
            throughputProgress: document.getElementById('throughput-progress'),
            
            blocksList: document.getElementById('blocks-list'),
            peersTable: document.getElementById('peers-table'),
            transactionsTable: document.getElementById('transactions-table'),
            outboxTable: document.getElementById('outbox-table'),
            
            refreshBlocksBtn: document.getElementById('refresh-blocks'),
            refreshPeersBtn: document.getElementById('refresh-peers'),
            refreshTxsBtn: document.getElementById('refresh-txs'),
            refreshOutboxBtn: document.getElementById('refresh-outbox'),
            refreshBlocksTreeBtn: document.getElementById('refresh-blocks-tree'),
            
            latencyBtn: document.getElementById('latency-btn'),
            throughputBtn: document.getElementById('throughput-btn'),

            overviewPage: document.getElementById('overview-page'),
            blocksPage: document.getElementById('blocks-page'),
            peersPage: document.getElementById('peers-page'),
            transactionsPage: document.getElementById('transactions-page'),
            performancePage: document.getElementById('performance-page'),
            outboxPage: document.getElementById('outbox-page'),
            settingsPage: document.getElementById('settings-page'),
            
            blocksTreeContainer: document.getElementById('blocks-tree-container')
        };
        
        function initDashboard() {
            elements.nodeId.textContent = peerId.substr(0, 6) + '...' + peerId.substr(-4);
            updateUptime();
            setInterval(updateUptime, 60000); 

            initChart();
            fetchDashboardData(); 
            setupPageNavigation(); 

            elements.refreshBlocksBtn.addEventListener('click', fetchLatestBlocks);
            elements.refreshPeersBtn.addEventListener('click', fetchPeers);
            elements.refreshTxsBtn.addEventListener('click', fetchTransactions);
            elements.refreshOutboxBtn.addEventListener('click', fetchOutbox);
            if(elements.refreshBlocksTreeBtn) { 
                elements.refreshBlocksTreeBtn.addEventListener('click', fetchBlocksTree);
            }
            
            elements.latencyBtn.addEventListener('click', () => setChartMode('latency'));
            elements.throughputBtn.addEventListener('click', () => setChartMode('throughput'));
            
            document.getElementById('search-input').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    const query = this.value.trim();
                    if (query) alert(`全局搜索: ${query}`);
                }
            });
            const blockTreeSearchBtn = document.getElementById('search-block-btn-tree');
            const blockTreeSearchInput = document.getElementById('block-search-tree');
            if (blockTreeSearchBtn && blockTreeSearchInput) {
                blockTreeSearchBtn.addEventListener('click', () => {
                    const query = blockTreeSearchInput.value.trim();
                    if (query) alert(`区块树搜索: ${query}`); // Implement actual search logic
                });
                 blockTreeSearchInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') {
                         const query = blockTreeSearchInput.value.trim();
                         if (query) alert(`区块树搜索: ${query}`); // Implement actual search logic
                    }
                });
            }
            setInterval(fetchDashboardData, 30000); 
        }
        
        function updateUptime() {
            const uptimeMs = Date.now() - startTime;
            const days = Math.floor(uptimeMs / (1000 * 60 * 60 * 24));
            const hours = Math.floor((uptimeMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((uptimeMs % (1000 * 60 * 60)) / (1000 * 60));
            elements.uptime.textContent = `${days}天 ${hours}小时 ${minutes}分钟`;
        }
        
        function initChart() {
            const ctx = document.getElementById('networkChart').getContext('2d');
            const rootStyles = getComputedStyle(document.documentElement);

            networkChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(12).fill("").map((_, i) => { 
                        const d = new Date(Date.now() - (11-i) * 30000); 
                        return `${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
                    }),
                    datasets: [{
                        label: '平均延迟 (ms)',
                        data: [],
                        borderColor: rootStyles.getPropertyValue('--highlight').trim(),
                        backgroundColor: 'rgba(233, 69, 96, 0.1)', // Fallback, or derive from --highlight
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointBackgroundColor: rootStyles.getPropertyValue('--highlight').trim()
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: rootStyles.getPropertyValue('--text').trim() } } },
                    scales: {
                        x: { 
                            grid: { color: rootStyles.getPropertyValue('--border').trim() }, 
                            ticks: { color: rootStyles.getPropertyValue('--text-secondary').trim(), maxRotation: 30, minRotation: 30 } 
                        },
                        y: { 
                            grid: { color: rootStyles.getPropertyValue('--border').trim() }, 
                            ticks: { color: rootStyles.getPropertyValue('--text-secondary').trim() }, 
                            beginAtZero: true 
                        }
                    }
                }
            });
        }
        
        function setChartMode(mode) {
            chartMode = mode;
            elements.latencyBtn.classList.toggle('active', mode === 'latency');
            elements.throughputBtn.classList.toggle('active', mode === 'throughput');
            updateChartData(true); 
        }
        
        function updateChartData(forceUpdate = false) {
            if (!networkChart) return;
            const rootStyles = getComputedStyle(document.documentElement);

            const now = new Date();
            const newLabel = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;

            if (networkChart.data.labels.length >= 12) {
                networkChart.data.labels.shift();
            }
            networkChart.data.labels.push(newLabel);

            if (chartMode === 'latency') {
                const avgLatency = latencyDataPoints.length > 0 ? latencyDataPoints.reduce((a,b)=>a+b,0) / latencyDataPoints.length : 0;
                if (networkChart.data.datasets[0].data.length >= 12) {
                    networkChart.data.datasets[0].data.shift();
                }
                networkChart.data.datasets[0].data.push(avgLatency);
                networkChart.data.datasets[0].label = '平均延迟 (ms)';
                networkChart.data.datasets[0].borderColor = rootStyles.getPropertyValue('--highlight').trim();
                networkChart.data.datasets[0].backgroundColor = 'rgba(233, 69, 96, 0.1)';
                networkChart.data.datasets[0].pointBackgroundColor = rootStyles.getPropertyValue('--highlight').trim();
                latencyDataPoints = []; 
            } else { 
                const avgThroughput = throughputDataPoints.length > 0 ? throughputDataPoints.reduce((a,b)=>a+b,0) / throughputDataPoints.length : 0;
                 if (networkChart.data.datasets[0].data.length >= 12) {
                    networkChart.data.datasets[0].data.shift();
                }
                networkChart.data.datasets[0].data.push(avgThroughput);
                networkChart.data.datasets[0].label = '吞吐量 (MB/s)';
                networkChart.data.datasets[0].borderColor = rootStyles.getPropertyValue('--success').trim();
                networkChart.data.datasets[0].backgroundColor = 'rgba(74, 222, 128, 0.1)';
                networkChart.data.datasets[0].pointBackgroundColor = rootStyles.getPropertyValue('--success').trim();
                throughputDataPoints = []; 
            }
            networkChart.update('none'); 
        }

        async function fetchDashboardData() {
            fetchPeers();
            fetchLatestBlocks();
            fetchTransactions();
            fetchOutbox();
            fetchNetworkPerformanceData(); 
        }

        async function fetchNetworkPerformanceData() {
            try {
                const [latencyRes, capacityRes] = await Promise.all([
                    fetch('/latency'),
                    fetch('/capacity')
                ]);
                if (latencyRes.ok) {
                    const data = await latencyRes.json();
                    data.forEach(item => latencyDataPoints.push(item.latency_ms));
                } else {
                    console.warn(`Failed to fetch latency: ${latencyRes.status}`);
                }
                if (capacityRes.ok) {
                    const data = await capacityRes.json();
                    throughputDataPoints.push(data.capacity); 
                    elements.networkThroughput.textContent = `${data.capacity.toFixed(1)} MB/s`;
                    elements.throughputProgress.style.width = `${Math.min(100, data.capacity / 50 * 100)}%`;
                } else {
                     console.warn(`Failed to fetch capacity: ${capacityRes.status}`);
                }
                updateChartData(); 
            } catch (error) {
                console.error('获取网络性能数据失败:', error);
            }
        }
        
        function setupPageNavigation() {
            const pageElements = {
                overview: elements.overviewPage,
                blocks: elements.blocksPage,
                peers: elements.peersPage,
                transactions: elements.transactionsPage,
                performance: elements.performancePage,
                outbox: elements.outboxPage,
                settings: elements.settingsPage
            };

            Object.values(pageElements).forEach(page => {
                if (page) page.style.display = 'none';
            });
            if (pageElements.overview) {
                pageElements.overview.style.display = 'block';
                document.querySelector('.nav-item[data-section="overview"]').classList.add('active');
                document.querySelector('.main-content .header h2').textContent = "网络总览";


            } else {
                console.error("Overview page element not found!");
            }
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    Object.values(pageElements).forEach(page => {
                        if (page) page.style.display = 'none';
                    });
                    
                    const currentPage = pageElements[section];
                    if (currentPage) {
                        currentPage.style.display = 'block';
                        // Update header title based on current page
                        const sectionTitle = this.querySelector('span').textContent;
                        document.querySelector('.main-content .header h2').textContent = sectionTitle;


                        if (section === 'blocks') {
                            if (elements.blocksTreeContainer) {
                                fetchBlocksTree();
                            } else {
                                console.error("Block tree container not found for section 'blocks'");
                            }
                        }
                    } else {
                        console.warn(`Page element for section '${section}' not found.`);
                    }
                });
            });
        }

        async function fetchBlocksTree() { // For Block Explorer Page
            const container = elements.blocksTreeContainer;
            if (!container) {
                console.error("Blocks tree container not found in DOM for fetchBlocksTree.");
                return;
            }
            container.innerHTML = `<div class="loading-block">
                                    <div class="block-row">
                                        <div class="block-icon"><i class="fas fa-cube"></i></div>
                                        <div class="block-info"><div>加载区块树结构中...</div></div>
                                    </div>
                                  </div>`;
            try {
                const response = await fetch('/blocks'); 
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                const data = await response.json();
                renderBlockTree(data, container);
            } catch (error) {
                console.error('获取区块树失败:', error);
                if (container) {
                    container.innerHTML = `<div class="empty-message">无法加载区块数据. Error: ${error.message}</div>`;
                }
            }
        }

        function renderBlockTree(data, container) { // For Block Explorer Page
            if (!data || (Array.isArray(data) && data.length === 0)) {
                container.innerHTML = '<div class="empty-message">区块链为空或无数据返回</div>';
                return;
            }
            container.innerHTML = ''; 
            
            function renderNode(node, parentElement, level) {
                const blockNode = document.createElement('div');
                blockNode.className = 'block-node';
                
                const blockHeader = document.createElement('div');
                blockHeader.className = 'block-header';
                blockNode.appendChild(blockHeader);
                
                const toggleIcon = document.createElement('div');
                toggleIcon.className = 'toggle-icon';
                blockHeader.appendChild(toggleIcon);
                
                const indicator = document.createElement('div');
                indicator.className = 'block-indicator';
                blockHeader.appendChild(indicator);
                
                const blockInfo = document.createElement('div');
                blockInfo.className = 'block-info';
                blockHeader.appendChild(blockInfo);
                
                const blockId = document.createElement('div');
                blockId.className = 'block-id';
                blockId.textContent = `区块 ID: ${node.block.block_id.substring(0,12)}...`;
                blockId.title = node.block.block_id;
                blockInfo.appendChild(blockId);
                
                const blockHash = document.createElement('div'); 
                blockHash.className = 'block-hash'; 
                const prevIdDisplay = (node.block.prev_id === "0000000000000000000000000000000000000000000000000000000000000000" || node.block.prev_id === "000000") 
                                    ? '创世块' 
                                    : (node.block.prev_id.substring(0,12) + '...');
                blockHash.textContent = `父区块: ${prevIdDisplay}`;
                blockHash.title = node.block.prev_id;
                blockInfo.appendChild(blockHash);
                
                const detailsContainer = document.createElement('div');
                detailsContainer.className = 'block-details';
                blockNode.appendChild(detailsContainer);
                
                const senderInfo = document.createElement('div');
                senderInfo.className = 'detail-row';
                senderInfo.innerHTML = `<span class="detail-label">生产者:</span><span class="detail-value">${node.block.sender || '未知'}</span>`;
                detailsContainer.appendChild(senderInfo);
                
                const timestampInfo = document.createElement('div');
                timestampInfo.className = 'detail-row';
                const time = new Date(node.block.timestamp * 1000);
                timestampInfo.innerHTML = `<span class="detail-label">时间:</span><span class="detail-value">${time.toLocaleString()}</span>`;
                detailsContainer.appendChild(timestampInfo);

                if (node.block.message_id) {
                    const msgIdInfo = document.createElement('div');
                    msgIdInfo.className = 'detail-row';
                    msgIdInfo.innerHTML = `<span class="detail-label">消息ID:</span><span class="detail-value">${node.block.message_id}</span>`;
                    detailsContainer.appendChild(msgIdInfo);
                }
                
                if (node.block.tx_list && node.block.tx_list.length) {
                    const txInfo = document.createElement('div');
                    txInfo.className = 'detail-row';
                    txInfo.innerHTML = `<span class="detail-label">交易数:</span><span class="detail-value">${node.block.tx_list.length}</span>`;
                    detailsContainer.appendChild(txInfo);
                    
                    const txList = document.createElement('div');
                    txList.className = 'tx-list';
                    node.block.tx_list.slice(0, 3).forEach(tx => {
                        const txItem = document.createElement('div');
                        txItem.className = 'tx-item';
                        const txDisplayId = (tx.tx_id || tx.message_id || '未知交易');
                        txItem.textContent = `TX: ${txDisplayId.substring(0,20)}...`;
                        txItem.title = txDisplayId;
                        txList.appendChild(txItem);
                    });
                    if (node.block.tx_list.length > 3) {
                        const more = document.createElement('div');
                        more.className = 'tx-item';
                        more.style.fontStyle = 'italic';
                        more.textContent = `+ ${node.block.tx_list.length - 3} 更多交易...`;
                        txList.appendChild(more);
                    }
                    detailsContainer.appendChild(txList);
                }
                
                let childrenContainer;
                const initiallyExpanded = level < 1; 

                if (node.children && node.children.length > 0) {
                    childrenContainer = document.createElement('div');
                    childrenContainer.className = 'children-container';
                    blockNode.appendChild(childrenContainer);
                    
                    detailsContainer.style.display = initiallyExpanded ? 'block' : 'none';
                    childrenContainer.style.display = initiallyExpanded ? 'block' : 'none';
                    toggleIcon.innerHTML = `<i class="fas ${initiallyExpanded ? 'fa-minus' : 'fa-plus'}"></i>`;

                    node.children.forEach(child => {
                        renderNode(child, childrenContainer, level + 1);
                    });
                } else {
                    toggleIcon.innerHTML = '•'; // Use a bullet for nodes with no children
                    detailsContainer.style.display = initiallyExpanded ? 'block' : 'none';
                }
                
                blockHeader.addEventListener('click', function() {
                    const detailsAreVisible = detailsContainer.style.display === 'block';
                    const newDisplayState = detailsAreVisible ? 'none' : 'block';
                    
                    detailsContainer.style.display = newDisplayState;
                    if (childrenContainer) {
                        childrenContainer.style.display = newDisplayState;
                        toggleIcon.innerHTML = `<i class="fas ${newDisplayState === 'block' ? 'fa-minus' : 'fa-plus'}"></i>`;
                    } else if (toggleIcon.innerHTML !== '•') { // Only update if it was +/-
                         // If it's a leaf node but was expandable (e.g. details only)
                        // This part might not be strictly necessary if '•' is used for no children
                    }
                });
                parentElement.appendChild(blockNode);
            }
            // Ensure data is an array before calling forEach
            if (Array.isArray(data)) {
                data.forEach(rootNode => renderNode(rootNode, container, 0));
            } else if (typeof data === 'object' && data !== null && data.block) {
                // Handle case where a single root node object is returned (less common for a list endpoint)
                 renderNode(data, container, 0);
            } else {
                console.error("Block data is not in expected array format:", data);
                container.innerHTML = '<div class="empty-message">区块数据格式错误</div>';
            }
        }

        // Helper function to extract all blocks from the tree and sort them by timestamp
        function extractAndSortBlocksFromTree(treeData) {
            const flatBlocks = [];
            const uniqueBlockIds = new Set();

            function traverse(nodes) {
                if (!Array.isArray(nodes)) return;
                nodes.forEach(node => {
                    if (node && node.block) {
                        if (!uniqueBlockIds.has(node.block.block_id)) {
                             flatBlocks.push({
                                hash: node.block.block_id, // 'hash' for consistency with updateBlocks
                                transactions: node.block.tx_list || [],
                                timestamp: node.block.timestamp
                            });
                            uniqueBlockIds.add(node.block.block_id);
                        }
                        if (node.children && node.children.length > 0) {
                            traverse(node.children);
                        }
                    }
                });
            }
            traverse(treeData);
            return flatBlocks.sort((a, b) => b.timestamp - a.timestamp);
        }
        
        async function fetchLatestBlocks() { // For the overview "最新区块" card
            try {
                const response = await fetch('/blocks'); // Assumes this returns the full tree
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                const treeData = await response.json();
                const sortedFlatBlocks = extractAndSortBlocksFromTree(treeData);
                updateBlocks(sortedFlatBlocks); // updateBlocks now expects a flat, sorted list
            } catch (error) {
                console.error('获取最新区块数据失败:', error);
                elements.blocksList.innerHTML = `<div class="block-row"><div class="block-icon"><i class="fas fa-exclamation-circle"></i></div><div class="block-info"><div>加载失败: ${error.message}</div></div></div>`;
            }
        }

        async function fetchPeers() {
            const loadingIcon = elements.refreshPeersBtn.querySelector('.loading');
            loadingIcon.style.display = 'inline-block';
            elements.refreshPeersBtn.disabled = true;
            try {
                const response = await fetch('/peers');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                const data = await response.json();
                updatePeers(data);
            } catch (error) {
                console.error('获取节点数据失败:', error);
                elements.peersTable.innerHTML = `<tr><td colspan="8" style="text-align: center; color: var(--danger);">加载失败: ${error.message}</td></tr>`;
            } finally {
                loadingIcon.style.display = 'none';
                elements.refreshPeersBtn.disabled = false;
            }
        }
        
        async function fetchTransactions() {
            elements.transactionsTable.innerHTML = '<tr><td colspan="3" style="text-align: center;">加载中...</td></tr>';
            try {
                const response = await fetch('/transactions');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                const data = await response.json();
                updateTransactions(data);
            } catch (error) {
                console.error('获取交易数据失败:', error);
                elements.transactionsTable.innerHTML = `<tr><td colspan="3" style="text-align: center; color: var(--danger);">加载失败: ${error.message}</td></tr>`;
            }
        }
        
        async function fetchOutbox() {
             elements.outboxTable.innerHTML = '<tr><td colspan="3" style="text-align: center;">加载中...</td></tr>';
            try {
                const response = await fetch('/outbox');
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                const data = await response.json();
                updateOutbox(data);
            } catch (error) {
                console.error('获取消息队列数据失败:', error);
                elements.outboxTable.innerHTML = `<tr><td colspan="3" style="text-align: center; color: var(--danger);">加载失败: ${error.message}</td></tr>`;
            }
        }
        
        function updatePeers(peers) {
            if (!Array.isArray(peers)) {
                console.error("Peers data is not an array:", peers);
                elements.peersTable.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--danger);">节点数据格式错误</td></tr>';
                elements.activePeers.textContent = "错误";
                return;
            }
            const activePeersCount = peers.filter(p => p.status === 'ONLINE').length;
            elements.activePeers.textContent = activePeersCount;
            elements.peersProgress.style.width = `${Math.min(100, activePeersCount / (peers.length || 1) * 100)}%`; 
            
            let tableHTML = '';
            peers.forEach(peer => {
                const shortId = peer.peer_id && peer.peer_id.length > 15 ? 
                    peer.peer_id.substr(0, 6) + '...' + peer.peer_id.substr(-6) : 
                    (peer.peer_id || '未知ID');
                
                let statusClass = 'status-offline'; let statusText = peer.status || '未知';
                if (peer.status === 'ALIVE') statusClass = 'status-online';
                else if (peer.status === 'MYSELF') statusClass = 'status-syncing';
                
                let latencyClass = 'latency-high';
                if (peer.latency < 100) latencyClass = 'latency-low';
                else if (peer.latency < 200) latencyClass = 'latency-medium';
                
                const peerTypeClass = peer.type === 'lightweight' ? 'peer-light' : 'peer-full';
                const peerTypeText = peer.type === 'lightweight' ? '轻节点' : '全节点';
                
                const natStatusText = peer.NATed ? '已启用' : '未启用';
                const natClass = peer.NATed ? 'status-warning' : 'status-success'; 
                
                tableHTML += `
                <tr>
                    <td title="${peer.peer_id || ''}">${shortId}</td>
                    <td>${peer.ip || 'N/A'}</td>
                    <td>${peer.port || 'N/A'}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td><span class="latency-indicator ${latencyClass}"></span> ${peer.latency != null ? peer.latency + ' ms' : 'N/A'}</td>
                    <td><span class="peer-type ${peerTypeClass}">${peerTypeText}</span></td>
                    <td><span class="status-badge ${natClass}">${natStatusText}</span></td>
                    <td>${peer.localnetworkid || 'N/A'}</td>
                </tr>`;
            });
            elements.peersTable.innerHTML = tableHTML || '<tr><td colspan="8" style="text-align: center;">无节点数据</td></tr>';
        }
        
        // updateBlocks is for "最新区块" list on overview page, expects flat sorted array of blocks
        function updateBlocks(latestBlocksFlat) {
            if (!Array.isArray(latestBlocksFlat)) {
                 console.error("Latest blocks data is not an array:", latestBlocksFlat);
                 elements.blocksList.innerHTML = '<div class="block-row"><div class="block-icon"><i class="fas fa-exclamation-circle"></i></div><div class="block-info"><div>区块数据格式错误</div></div></div>';
                 return;
            }

            const totalBlockCount = latestBlocksFlat.length; // This is the count of unique blocks from the tree
            elements.blockCountStat.textContent = totalBlockCount;
            elements.blockHeightSysInfo.textContent = `#${totalBlockCount}`;
            elements.blocksProgress.style.width = `${Math.min(100, (totalBlockCount % 1000) / 10)}%`; 

            let blocksHTML = '';
            latestBlocksFlat.slice(0, 5).forEach(block => { 
                const blockHashShort = block.hash ? 
                    block.hash.substr(0, 8) + '...' + block.hash.substr(-8) : 
                    '未知哈希';
                const txCount = block.transactions ? block.transactions.length : 0;
                const timeAgo = block.timestamp ? formatTimeAgo(block.timestamp * 1000) : "未知时间";
                
                blocksHTML += `
                <div class="block-row">
                    <div class="block-icon"><i class="fas fa-cube"></i></div>
                    <div class="block-info">
                        <div>区块 <span class="block-hash" title="${block.hash || ''}">${blockHashShort}</span></div>
                        <div>${txCount} 笔交易 | ${timeAgo}</div>
                    </div>
                </div>`;
            });
            elements.blocksList.innerHTML = blocksHTML || '<div class="block-row"><div class="block-icon"><i class="fas fa-cube"></i></div><div class="block-info"><div>无区块数据</div></div></div>';
        }

        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const seconds = Math.round((now - timestamp) / 1000);

            if (seconds < 5) return `刚刚`;
            if (seconds < 60) return `${seconds} 秒前`;
            
            const minutes = Math.round(seconds / 60);
            if (minutes < 60) return `${minutes} 分钟前`;
            
            const hours = Math.round(minutes / 60);
            if (hours < 24) return `${hours} 小时前`;
            
            const days = Math.round(hours / 24);
            return `${days} 天前`;
        }
        
        function updateTransactions(transactions) {
            if (!Array.isArray(transactions)) {
                console.error("Transactions data is not an array:", transactions);
                elements.transactionsTable.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--danger);">交易数据格式错误</td></tr>';
                elements.pendingTxs.textContent = "错误";
                return;
            }
            const pendingTxsCount = transactions.filter(tx => tx.status === 'PENDING' || tx.status === '待处理').length; // Adjusted for PENDING
            elements.pendingTxs.textContent = pendingTxsCount;
            elements.txsProgress.style.width = `${Math.min(100, pendingTxsCount / (transactions.length || 1) * 100)}%`;
            
            let tableHTML = '';
            transactions.slice(0, 5).forEach(tx => { 
                const txIdShort = tx.id ? tx.id.substr(0, 8) + '...' + tx.id.substr(-8) : '未知ID';
                const amount = tx.amount != null ? `${tx.amount} ETH` : '未知金额'; // Ensure amount exists
                let statusClass = 'status-syncing'; let statusText = tx.status || '未知';
                if (tx.status === 'CONFIRMED' || tx.status === '已确认') { statusClass = 'status-online'; statusText = '已确认'; }
                else if (tx.status === 'FAILED' || tx.status === '失败') { statusClass = 'status-offline'; statusText = '失败'; }
                else if (tx.status === 'PENDING' || tx.status === '待处理') { statusClass = 'status-syncing'; statusText = '待处理';}

                tableHTML += `
                <tr>
                    <td title="${tx.id || ''}">${txIdShort}</td>
                    <td>${amount}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                </tr>`;
            });
            elements.transactionsTable.innerHTML = tableHTML || '<tr><td colspan="3" style="text-align: center;">无交易数据</td></tr>';
        }
        
        function updateOutbox(outboxDataContainer) {
            const outbox = outboxDataContainer ? outboxDataContainer.data : null;
            if (!outbox || typeof outbox !== 'object') {
                 console.error("Outbox data is not in the expected format:", outboxDataContainer);
                 elements.outboxTable.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--danger);">消息队列数据格式错误</td></tr>';
                 return;
            }
            
            let tableHTML = '';
            Object.entries(outbox).slice(0, 5).forEach(([peerId, data]) => { 
                const shortId = peerId.length > 15 ? peerId.substr(0, 6) + '...' + peerId.substr(-6) : peerId;
                let priorityClass = 'priority-medium'; let priorityText = '中';
                if (data.high_priority > 0) { priorityClass = 'priority-high'; priorityText = '高'; }
                else if (data.low_priority > 0 && data.medium_priority === 0 && data.high_priority === 0) { priorityClass = 'priority-low'; priorityText = '低';}
                
                tableHTML += `
                <tr>
                    <td title="${peerId}">${shortId}</td>
                    <td><span class="queue-priority ${priorityClass}">${priorityText}</span></td>
                    <td>${data.total != null ? data.total : 'N/A'}</td>
                </tr>`;
            });
            elements.outboxTable.innerHTML = tableHTML || '<tr><td colspan="3" style="text-align: center;">无待发送消息</td></tr>';
        }
        
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>